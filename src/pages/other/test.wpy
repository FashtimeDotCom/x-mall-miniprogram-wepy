<style lang="scss">
  .test{
    background: #ff0000;
    width: 300rpx;
    height: 50rpx;
    border: solid 1px #e6e6e6;
  }
</style>
<template>
  <view class="test"
        @tap="actionClickPay">
    去支付{{status}}
    {{options}}
  </view>
</template>

<script>
  import wepy from 'wepy'
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: 'just a test'
    }
    components = {
    }

    data = {
      status: '未开始',
      options: ''
    }

    computed = {
      now () {
        return +new Date()
      }
    }

    onShareAppMessage(res) {
      if (res.from === 'button') {
        // 来自页面内转发按钮
      }
      /* eslint-disable */
      if (wx.getStorageSync('session_key')){
            console.log(wx.getStorageSync('session_key'))
      } else {
        wx.login({
          success: function(res) {
            console.log(res);
            wx.request({
              url: 'https://api.weixin.qq.com/sns/jscode2session?appid=wx58b1b582646001c0&secret=11d8a3a9d076d1edc7f68b3f882d2baf&js_code='+ res.code +'&grant_type=authorization_code',
              data: {},
              header: {
                'content-type': 'application/json'
              },
              success: function(res) {
                console.log(res.data.session_key);
                wx.setStorageSync('session_key', res.data.session_key)
              }
            })

          },
          fail: function (error) {
            console.log(error);
          }
        });
      }
      /* eslint-enable */

      let paramString = 'cuppi, you are the best';
      return {
        title: '自定义转发标题',
        path: 'pages/other/pay?payUrl=' + paramString,
        success: function(res) {
          // 转发成功
          console.log('转发成功');
          console.log(res);
          let shareTickets = res.shareTickets;
          if (shareTickets && shareTickets.length > 0){
            let shareTicket = shareTickets[0];
            wepy.getShareInfo({
              shareTicket,
              complete (res1) {
                console.log('获取到群信息');
                console.log(res1)
              }
            });
          }
        },
        fail: function(res) {
          // 转发失败
          console.log('转发失败');
        }
      }
    }

    methods = {
      actionClickPay(){
        /* eslint-disable */
        this.status = '点击';
          wx.navigateTo({
            // url: 'pay?payUrl=' + wx.getStorageSync('payUrl')
            url: 'pay?payUrl=asdasdasd'
          })
        // if (wx.getStorageSync('payUrl')){
        //   wx.navigateTo({
        //     url: 'pay?payUrl=' + wx.getStorageSync('payUrl')
        //   })
        //   return;
        // }
        // wx.request({
        //   url: 'http://local.idoupiao.com:4888/xabcjsfilm/pay/lyconfirmpay.api',
        //   data: {
        //     inType: 'JiangSuABC',
        //     openId: 'oxmudxLXzqKWTSnZ8ikaJscicl-Y',
        //     signCode: '23b4044b11af85609d76089aea44a924',
        //     userId: '13764730291',
        //     secret: '074CA81E531E7DAD4DB60458E5A9C66B5C147794',
        //     from: '',
        //     bean: 0,
        //     isSubTenAct: false,
        //     privilegeCount: 0,
        //     orderId: 16268
        //   },
        //   success: function (data) {
        //     // wx.showToast({
        //     //   title: 'asd',
        //     //   duration: 5000
        //     // });
        //     this.status = '请求成功';
        //     console.log(data.data.data);
        //     wx.setStorageSync('payUrl', encodeURIComponent(data.data.data));
        //     wx.navigateTo({
        //       url: 'pay?payUrl=' + encodeURIComponent(data.data.data)
        //     })
        //   },
        //   fail: function () {
        //     this.status = '请求失败';
        //     console.log('请求失败');
        //   }
        // })
        // wx.navigateTo({
        //   url: 'pay?payUrl=' + payUrl
        // })
        /* eslint-enable */
      }
    }

    onLoad() {
      /* eslint-disable */
      wx.showShareMenu({
        withShareTicket: true
      })
      console.log(this.$parent.globalData.options)
      this.options = JSON.stringify(this.$parent.globalData.options);
      /* eslint-enable */
    }
  }
</script>
